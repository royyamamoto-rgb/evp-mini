<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>EVP-MINI — Paranormal Investigation PWA</title>
  <meta name="theme-color" content="#0a0a14">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="Professional paranormal investigation toolkit — EVP capture, spirit box simulation, visual anomaly detection, and EMF sensing.">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/icon-192.png">
  <link rel="apple-touch-icon" href="assets/icon-192.png">
  <link rel="stylesheet" href="css/styles.css?v=1">

  <!-- Cache nuke — kill old service workers -->
  <script>
  (function() {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(regs) {
        regs.forEach(function(r) { r.unregister(); });
      });
    }
    if ('caches' in window) {
      caches.keys().then(function(names) {
        names.forEach(function(n) { caches.delete(n); });
      });
    }
  })();
  </script>
</head>
<body>
  <!-- ========== PASSWORD GATE ========== -->
  <div class="password-gate" id="passwordGate">
    <div class="password-card">
      <div class="gate-logo">&#x1F47B;</div>
      <h2>EVP-MINI</h2>
      <p>Paranormal Investigation Suite</p>
      <div class="error" id="passwordError">Incorrect password</div>
      <input type="password" id="sitePassword" placeholder="Enter access code" autofocus>
      <button class="auth-btn" id="passwordSubmit">Enter Investigation</button>
    </div>
  </div>

  <!-- ========== MAIN APP ========== -->
  <div class="app-wrapper" id="appWrapper">

    <!-- Header -->
    <div class="header">
      <div>
        <h1>&#x1F47B; EVP-MINI</h1>
        <div class="subtitle">Paranormal Investigation Suite</div>
      </div>
      <div class="header-actions">
        <span id="modeBadge" class="mode-badge" style="display:none;"></span>
        <span id="nirBadge" class="nir-badge" style="display:none;">700-950nm NIR</span>
        <button id="btnFlip" class="flip-btn" title="Flip Camera">&#x21C5; Flip</button>
      </div>
    </div>

    <!-- Main Two-Panel Layout -->
    <div class="main-container">

      <!-- ===== LEFT PANEL — Live View & Controls ===== -->
      <div class="panel panel-left">

        <!-- Camera View -->
        <div class="camera-section">
          <video id="video" autoplay playsinline muted></video>
          <canvas id="overlayCanvas"></canvas>
          <div id="liveIndicator" class="live-indicator" style="display:none;">
            <span class="live-dot"></span> LIVE
          </div>
          <div id="recordingIndicator" class="recording-indicator" style="display:none;">
            <span class="rec-dot"></span> REC
          </div>
        </div>

        <!-- Scan Mode Selector -->
        <div class="control-group">
          <label class="control-label">Scan Mode</label>
          <div class="mode-selector" id="modeSelector">
            <button class="mode-btn active" data-mode="evp">&#x1F399; EVP Scan</button>
            <button class="mode-btn" data-mode="spiritbox">&#x1F4FB; Spirit Box</button>
            <button class="mode-btn" data-mode="visual">&#x1F441; Visual Scan</button>
            <button class="mode-btn mode-btn-spectrum" data-mode="fullspectrum">&#x1F31F; Full Spectrum</button>
          </div>
        </div>

        <!-- Duration Selector -->
        <div class="control-group">
          <label class="control-label">Duration</label>
          <div class="duration-selector" id="durationSelector">
            <button class="dur-btn active" data-duration="0">Continuous</button>
            <button class="dur-btn" data-duration="30">30s</button>
            <button class="dur-btn" data-duration="60">60s</button>
            <button class="dur-btn" data-duration="120">120s</button>
          </div>
        </div>

        <!-- Start/Stop Controls -->
        <div class="control-group control-buttons">
          <button id="btnStart" class="btn btn-start" disabled>&#x25B6; Start Investigation</button>
          <button id="btnStop" class="btn btn-stop" style="display:none;">&#x25A0; Stop</button>
        </div>

        <!-- Status Bar -->
        <div id="statusBar" class="status-bar ready">Initializing sensors...</div>

        <!-- Timer -->
        <div id="timerSection" class="timer-section" style="display:none;">
          <span class="timer-label">Elapsed</span>
          <span id="timerValue" class="timer-value">0:00</span>
        </div>

        <!-- Spectrogram -->
        <div class="control-group">
          <label class="control-label">Audio Spectrogram</label>
          <canvas id="spectrogramCanvas" class="spectrogram-canvas" width="600" height="120"></canvas>
        </div>

        <!-- Audio Meters -->
        <div class="meters-section">
          <div class="meter">
            <span class="meter-label">RMS Level</span>
            <div class="meter-bar"><div id="meterRms" class="meter-fill meter-fill-cyan" style="width:0%"></div></div>
            <span id="meterRmsVal" class="meter-value">-∞ dB</span>
          </div>
          <div class="meter">
            <span class="meter-label">HNR</span>
            <div class="meter-bar"><div id="meterHnr" class="meter-fill meter-fill-purple" style="width:0%"></div></div>
            <span id="meterHnrVal" class="meter-value">0 dB</span>
          </div>
          <div class="meter">
            <span class="meter-label">SNR</span>
            <div class="meter-bar"><div id="meterSnr" class="meter-fill meter-fill-green" style="width:0%"></div></div>
            <span id="meterSnrVal" class="meter-value">0 dB</span>
          </div>
        </div>

        <!-- Sensor Readings -->
        <div class="control-group">
          <label class="control-label">Environmental Sensors</label>
          <div class="sensor-grid">
            <div class="sensor-card" id="sensorEmf">
              <div class="sensor-icon">&#x1F9F2;</div>
              <div class="sensor-label">EMF</div>
              <div class="sensor-value" id="emfValue">--</div>
              <div class="sensor-unit">&mu;T</div>
              <div class="sensor-status" id="emfStatus">Initializing</div>
            </div>
            <div class="sensor-card" id="sensorVibration">
              <div class="sensor-icon">&#x1F4F3;</div>
              <div class="sensor-label">Vibration</div>
              <div class="sensor-value" id="vibrationValue">--</div>
              <div class="sensor-unit">m/s&sup2;</div>
              <div class="sensor-status" id="vibrationStatus">Initializing</div>
            </div>
            <div class="sensor-card" id="sensorPressure">
              <div class="sensor-icon">&#x1F321;</div>
              <div class="sensor-label">Pressure</div>
              <div class="sensor-value" id="pressureValue">--</div>
              <div class="sensor-unit">hPa</div>
              <div class="sensor-status" id="pressureStatus">Initializing</div>
            </div>
          </div>
        </div>

        <!-- Spirit Box Panel (hidden unless spiritbox or fullspectrum mode) -->
        <div id="spiritBoxPanel" class="spirit-box-panel" style="display:none;">
          <label class="control-label">Spirit Box</label>
          <div class="spirit-box-display">
            <div class="spirit-freq" id="spiritFreq">87.5</div>
            <div class="spirit-freq-unit">MHz</div>
          </div>
          <div class="spirit-controls">
            <div class="spirit-control">
              <label>Sweep Speed</label>
              <input type="range" id="sweepSpeed" min="30" max="350" value="100" step="10">
              <span id="sweepSpeedVal">100ms</span>
            </div>
            <div class="spirit-control">
              <label>Noise Type</label>
              <div class="noise-toggle">
                <button class="noise-btn active" data-noise="white">White</button>
                <button class="noise-btn" data-noise="pink">Pink</button>
              </div>
            </div>
            <div class="spirit-control">
              <label>Noise Level</label>
              <input type="range" id="noiseLevel" min="0" max="100" value="30" step="5">
            </div>
            <div class="spirit-control">
              <label>Tone Level</label>
              <input type="range" id="toneLevel" min="0" max="100" value="40" step="5">
            </div>
          </div>
          <div id="spiritFragments" class="spirit-fragments"></div>
        </div>

        <!-- Visual Mode Selector (hidden unless visual or fullspectrum mode) -->
        <div id="visualModePanel" class="visual-mode-panel" style="display:none;">
          <label class="control-label">Visual Enhancement</label>
          <div class="visual-mode-selector" id="visualModeSelector">
            <button class="vis-btn active" data-visual="normal">Normal</button>
            <button class="vis-btn" data-visual="nightvision">Night Vision</button>
            <button class="vis-btn" data-visual="edge">Edge Detect</button>
            <button class="vis-btn" data-visual="falsecolor">False Color</button>
            <button class="vis-btn" data-visual="motion">Motion</button>
            <button class="vis-btn" data-visual="motiontrails">Trails</button>
            <button class="vis-btn" data-visual="fullspectrum">Full Spectrum</button>
          </div>
        </div>

        <!-- Live Indicator Chips -->
        <div class="live-chips" id="liveChips" style="display:none;">
          <span class="chip chip-motion" id="chipMotion">Motion: 0%</span>
          <span class="chip chip-emf" id="chipEmf">EMF: -- &mu;T</span>
          <span class="chip chip-audio" id="chipAudio">Audio: -∞ dB</span>
          <span class="chip chip-evp" id="chipEvp" style="display:none;">EVP: --</span>
        </div>

        <!-- Recording Controls -->
        <div class="control-group recording-controls">
          <button id="btnRecord" class="btn btn-record" disabled>&#x23FA; Record</button>
          <button id="btnStopRecord" class="btn btn-stop-record" style="display:none;">&#x23F9; Stop Rec</button>
          <button id="btnReverse" class="btn btn-reverse" disabled>&#x23EA; Reverse Play</button>
          <button id="btnExport" class="btn btn-export" disabled>&#x1F4BE; Export Audio</button>
        </div>

      </div>

      <!-- ===== RIGHT PANEL — Evidence Report ===== -->
      <div class="panel panel-right">
        <div class="report-header">
          <h2>&#x1F4CB; Evidence Report</h2>
          <button id="btnExportReport" class="btn btn-export-report" disabled>Export Report</button>
        </div>

        <div id="reportContent" class="report-content">
          <div class="report-placeholder">
            <p>Start an investigation to begin collecting evidence.</p>
            <p class="report-hint">Select a scan mode, set duration, and press Start.</p>
          </div>
        </div>

        <!-- Report sections (populated dynamically by app.js) -->
        <div id="reportSections" class="report-sections" style="display:none;">

          <!-- Investigation Summary -->
          <div class="report-section">
            <div class="report-section-header" data-toggle="summaryBody">
              <h3>Investigation Summary</h3>
              <span class="toggle-icon">&#x25BC;</span>
            </div>
            <div id="summaryBody" class="report-section-body">
              <div id="reportSummary"></div>
            </div>
          </div>

          <!-- Audio Evidence -->
          <div class="report-section">
            <div class="report-section-header" data-toggle="audioBody">
              <h3>&#x1F399; Audio Evidence</h3>
              <span class="toggle-icon">&#x25BC;</span>
            </div>
            <div id="audioBody" class="report-section-body">
              <div id="reportAudio"></div>
            </div>
          </div>

          <!-- EVP Classifications -->
          <div class="report-section">
            <div class="report-section-header" data-toggle="evpBody">
              <h3>&#x1F47B; EVP Classifications</h3>
              <span class="toggle-icon">&#x25BC;</span>
            </div>
            <div id="evpBody" class="report-section-body">
              <div id="reportEvp"></div>
            </div>
          </div>

          <!-- Visual Findings -->
          <div class="report-section">
            <div class="report-section-header" data-toggle="visualBody">
              <h3>&#x1F441; Visual Findings</h3>
              <span class="toggle-icon">&#x25BC;</span>
            </div>
            <div id="visualBody" class="report-section-body">
              <div id="reportVisual"></div>
            </div>
          </div>

          <!-- Sensor Data -->
          <div class="report-section">
            <div class="report-section-header" data-toggle="sensorBody">
              <h3>&#x1F9F2; Sensor Data</h3>
              <span class="toggle-icon">&#x25BC;</span>
            </div>
            <div id="sensorBody" class="report-section-body">
              <div id="reportSensors"></div>
            </div>
          </div>

          <!-- Spirit Box Results -->
          <div class="report-section" id="spiritBoxReportSection" style="display:none;">
            <div class="report-section-header" data-toggle="spiritBody">
              <h3>&#x1F4FB; Spirit Box Results</h3>
              <span class="toggle-icon">&#x25BC;</span>
            </div>
            <div id="spiritBody" class="report-section-body">
              <div id="reportSpirit"></div>
            </div>
          </div>

          <!-- Scientific Context -->
          <div class="report-section">
            <div class="report-section-header" data-toggle="scienceBody">
              <h3>&#x1F52C; Scientific Context</h3>
              <span class="toggle-icon">&#x25BC;</span>
            </div>
            <div id="scienceBody" class="report-section-body">
              <div id="reportScience"></div>
            </div>
          </div>

          <!-- Disclaimer -->
          <div class="report-disclaimer" id="reportDisclaimer">
            <strong>Disclaimer:</strong> This application uses real sensor data and signal processing algorithms. However, it cannot verify or confirm paranormal activity. All findings should be interpreted with scientific skepticism. Anomalies may have mundane explanations including environmental noise, electromagnetic interference, device movement, or sensor limitations.
          </div>
        </div>
      </div>
    </div>

    <!-- iOS Sensor Permission Banner -->
    <div id="sensorPermBanner" class="sensor-perm-banner" style="display:none;">
      <p>iOS requires permission for motion &amp; orientation sensors.</p>
      <button id="btnSensorPerm" class="btn btn-sensor-perm">Grant Sensor Access</button>
    </div>

  </div>

  <!-- Scripts -->
  <script src="js/evp-audio-engine.js?v=1"></script>
  <script src="js/visual-anomaly-engine.js?v=1"></script>
  <script src="js/emf-sensor-engine.js?v=1"></script>
  <script src="js/spirit-box-engine.js?v=1"></script>
  <script src="js/evp-classifier.js?v=1"></script>
  <script src="js/session-recorder.js?v=1"></script>
  <script src="js/evidence-report.js?v=1"></script>
  <script src="js/app.js?v=1"></script>
</body>
</html>
